#!/usr/bin/env bash
[ ! "$HOME" ] && { echo "Missing \$HOME env variable"; exit 1; }

# Create backup dir
rm -Rf "$HOME/.dotfiles_backup"
mkdir -p "$HOME/.dotfiles_backup"

# Install ~/.ssh/config on Darwin
if [ "$(uname)" == "Darwin" ]; then
  echo -n "$HOME/.ssh/config - copying..."
  [ -f "$HOME/.ssh/config" ] && mv -f "$HOME/.ssh/config" "$HOME/.dotfiles_backup" && echo " [saved backup]" || echo
  mkdir -p "$HOME/.ssh/control"
  cp -f "$HOME/.dotfiles/ssh_config_darwin" "$HOME/.ssh/config"
fi

safe_copy() {
  echo -n "$HOME/.$1 - copying..." 
  [ -f "$HOME/.$1" ] && mv -f "$HOME/.$1" "$HOME/.dotfiles_backup" && echo " [saved backup]" || echo
  cp -f "$HOME/.dotfiles/$1" "$HOME/.$1"
}

# Install dotfiles on $HOME
DOTFILES_SAFE=( bashrc bash_common gitconfig gitignore_global 
                vimrc inputrc tmux.conf vimrc dir_colors)
for dotfile in "${DOTFILES_SAFE[@]}"; do
  safe_copy "$dotfile"
done

# Copy GIT_ variable values to .gitconfig
if [[ "$(uname)" =~ Darwin ]]; then
  [ -f "$HOME/.bash_profile" ] && . "$HOME/.bash_profile"
  [ "$GIT_AUTHOR_NAME" ]  && git config --global user.name  "$GIT_AUTHOR_NAME"
  [ "$GIT_AUTHOR_EMAIL" ] && git config --global user.email "$GIT_AUTHOR_EMAIL"
fi

# Check if .bash_profile has no values
[ -f "$HOME/.bash_apikeys" ] && rm -f "$HOME/.bash_apikeys"
if [ -f "$HOME/.bash_profile" ]; then
  unset HOMEBREW_GITHUB_API_TOKEN GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL 
  unset GIT_COMMITTER_NAME GIT_COMMITTER_EMAIL 
  . "$HOME/.bash_profile"
  if [ ! "$HOMEBREW_GITHUB_API_TOKEN" ] && [ ! "$GIT_AUTHOR_NAME" ] && \
     [ ! "$GIT_AUTHOR_EMAIL" ] && [ ! "$GIT_COMMITTER_NAME" ] && \
     [ ! "$GIT_COMMITTER_EMAIL" ]; then
     safe_copy "bash_profile"
  fi
else
  safe_copy "bash_profile"
fi

# Disable GIT_ env from profile on Linux/BSD
if [[ ! "$(uname)" =~ Darwin ]]; then
  sed -i 'bak' -e 's/^export GIT/#export GIT/g' "$HOME/.bash_profile"
  rm -f "$HOME/.bash_profile.bak"
fi

# All done
echo
echo "New dotfiles on $HOME/.dotfiles"
echo "Backup of your last dotfiles on $HOME/.dotfiles_backup"
echo
echo "All done. Restart your terminal"
